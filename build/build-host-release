#!/bin/bash
#===================================================================================================
# CyborgAI Host Build Release Script
# CC BY-NC-ND 4.0 Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International
#===================================================================================================

set -e

# Default values
TARGET=""
FEATURES="full"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -t|--target)
            TARGET="$2"
            shift 2
            ;;
        -f|--features)
            FEATURES="$2"
            shift 2
            ;;
        *)
            shift
            ;;
    esac
done

if [ -z "$TARGET" ]; then
    echo "Error: Target not specified. Use -t <target>"
    exit 1
fi

echo "Building for target: $TARGET"
echo "Features: $FEATURES"

# Create release directory
mkdir -p release

# Build command
BUILD_CMD="cargo build --release --target $TARGET"

if [ "$FEATURES" != "" ] && [ "$FEATURES" != "full" ] && [ "$FEATURES" != "default" ]; then
    BUILD_CMD="$BUILD_CMD --features $FEATURES"
fi

echo "Executing: $BUILD_CMD"

# Determine if we're in the build directory or root directory
if [ -d "app_cyborgai_cli" ]; then
    # We're in the root directory - this is a workspace build
    BUILD_DIR="build"
    WORKSPACE_ROOT="."
elif [ -d "../app_cyborgai_cli" ]; then
    # We're in the build directory
    BUILD_DIR="."
    WORKSPACE_ROOT=".."
else
    echo "Error: Cannot find app_cyborgai_cli directory"
    exit 1
fi

# Build from workspace root since this is a workspace
cd "$WORKSPACE_ROOT"
eval $BUILD_CMD

# Find the built binary - in workspace builds, target is in the workspace root
BINARY_NAME="cyborgai_cli"
if [[ "$TARGET" == *"-windows-"* ]]; then
    BINARY_NAME="cyborgai_cli.exe"
fi

BINARY_PATH="target/$TARGET/release/$BINARY_NAME"

if [ ! -f "$BINARY_PATH" ]; then
    echo "Error: Binary not found at $BINARY_PATH"
    exit 1
fi

# Copy to release directory
RELEASE_NAME="cyborgai_cli-$TARGET"
if [[ "$TARGET" == *"-windows-"* ]]; then
    RELEASE_NAME="$RELEASE_NAME.exe"
fi

mkdir -p "$BUILD_DIR/release"
cp "$BINARY_PATH" "$BUILD_DIR/release/$RELEASE_NAME"

echo "Build completed: release/$RELEASE_NAME"